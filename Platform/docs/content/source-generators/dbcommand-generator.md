---
title: DbCommand Generator
description: Details on the DbCommandSourceGenerator, which automates Dapper command and query handler generation.
---

# DbCommand Generator

The `DbCommandSourceGenerator` is a key component within the Platform that leverages C# Source Generators to automate the creation of Dapper-based command and query handlers. This generator significantly reduces the boilerplate code typically associated with database interactions, allowing developers to focus on defining their data transfer objects (DTOs) and commands/queries.

## How it Works

When you apply the `[DbCommand]` attribute to a class or record, the `DbCommandSourceGenerator` analyzes its properties and the parameters defined in the attribute. Based on this information, it generates:

1.  **`ToDbParams()` method**: This method converts the properties of your class into an anonymous object or a `DynamicParameters` object (for Dapper) that can be directly used as parameters for database commands. It handles casing conventions (e.g., snake_case) as specified by the `DbParamsCase` enum or `[Column]` attribute.
2.  **Command/Query Handler**: If you specify `sp`, `sql`, or `fn` in the `[DbCommand]` attribute, the generator also creates a handler method that executes the specified stored procedure, SQL query, or function using Dapper. This handler integrates seamlessly with messaging systems like Wolverine if configured.

## Usage with DbCommandAttribute

The `DbCommandGenerator` works in conjunction with the `[DbCommand]` attribute (defined in `Operations.Extensions.Abstractions.Dapper`). The parameters you provide to this attribute guide the generator in creating the appropriate code.

For detailed usage of the `[DbCommand]` attribute, refer to its documentation.

## Generated code examples

Consider a command defined as:

```csharp
using Operations.Extensions.Abstractions.Dapper;
using Operations.Extensions.Abstractions.Messaging;

[DbCommand(sp: "dbo.CreateUser", nonQuery: true)]
public partial record CreateUserCommand(string UserName, string Email) : ICommand<int>;
```

The `DbCommandSourceGenerator` generates two types of code:

### ToDbParams method generation

For the `IDbParamsProvider` implementation:

```csharp
// File: CreateUserCommand.DbExt.g.cs
// <auto-generated/>
#nullable enable

partial record CreateUserCommand : global::Operations.Extensions.Abstractions.Dapper.IDbParamsProvider
{
    public global::System.Object ToDbParams()
    {
        return this;
    }
}
```

### Static handler generation

For commands with `sp`, `sql`, or `fn` parameters, a static handler class is generated:

```csharp
// File: CreateUserCommand.g.cs
// <auto-generated/>
#nullable enable

using Dapper;

public static class CreateUserCommandHandler
{
    public static async global::System.Threading.Tasks.Task<global::System.Int32> HandleAsync(
        global::YourNamespace.CreateUserCommand command, 
        global::System.Data.Common.DbDataSource datasource, 
        global::System.Threading.CancellationToken cancellationToken = default)
    {
        await using var connection = await datasource.OpenConnectionAsync(cancellationToken);
        var dbParams = command.ToDbParams();
        return await global::Dapper.SqlMapper.ExecuteAsync(connection, 
            new global::Dapper.CommandDefinition("dbo.CreateUser", dbParams, 
                commandType: System.Data.CommandType.StoredProcedure, 
                cancellationToken: cancellationToken));
    }
}
```

### Keyed data source support

For commands with the `dataSource` parameter:

```csharp
[DbCommand(sp: "dbo.UpdateUser", nonQuery: true, dataSource: "UserDb")]
public partial record UpdateUserCommand(int UserId, string Name) : ICommand<int>;
```

The generated handler uses `[FromKeyedServices]` attribute:

```csharp
public static class UpdateUserCommandHandler
{
    public static async global::System.Threading.Tasks.Task<global::System.Int32> HandleAsync(
        global::YourNamespace.UpdateUserCommand command, 
        [global::Microsoft.Extensions.DependencyInjection.FromKeyedServicesAttribute("UserDb")] 
        global::System.Data.Common.DbDataSource datasource, 
        global::System.Threading.CancellationToken cancellationToken = default)
    {
        // Implementation similar to above
    }
}
```

This static handler approach integrates seamlessly with dependency injection and can be called directly or through messaging frameworks.

## See also

*   [DbCommandAttribute](../database/dbcommand-attribute.md)
*   [Source Generators Overview](overview.md)
*   [Dapper](https://github.com/DapperLib/Dapper)
